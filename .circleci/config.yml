version: 2.1

jobs:
  deploy:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout
      - run:
          name: Notify Slack - Deployment Started
          command: |
            BRANCH=$(git rev-parse --abbrev-ref HEAD)
            COMMIT_MESSAGE=$(git log -1 --pretty=format:'%s')
            AUTHOR=$(git log -1 --pretty=format:'%an <%ae>')
            curl -X POST -H 'Content-type: application/json' --data "{
              \"blocks\": [
                {
                  \"type\": \"header\",
                  \"text\": {
                    \"type\": \"plain_text\",
                    \"text\": \"ðŸš€ Deployment Started\"
                  }
                },
                {
                  \"type\": \"section\",
                  \"fields\": [
                    {
                      \"type\": \"mrkdwn\",
                      \"text\": \"*Branch:* $BRANCH\"
                    },
                    {
                      \"type\": \"mrkdwn\",
                      \"text\": \"*Commit:* $COMMIT_MESSAGE\"
                    },
                    {
                      \"type\": \"mrkdwn\",
                      \"text\": \"*Author:* $AUTHOR\"
                    }
                  ]
                }
              ]
            }" https://hooks.slack.com/services/REPLACE/WITH/ACTUAL_WEBHOOK
      - add_ssh_keys:
          fingerprints:
            - "SHA256:X3RD1erbC+w6Iqz/fZoHZUrweUqOIny4BgOT1KAruPM"
      - run:
          name: SSH to EC2 and deploy
          command: ssh -o StrictHostKeyChecking=no root@3.111.35.110 "bash /root/toolplate-backend/deploy.sh > /root/toolplate-backend/deploy_output.txt"
      - run:
          name: Download deploy_output.txt
          command: scp -o StrictHostKeyChecking=no root@3.111.35.110:/root/toolplate-backend/deploy_output.txt .
      - run:
          name: Notify Slack - Deployment Succeeded
          when: on_success
          command: |
            DEPLOY_OUTPUT=$(< deploy_output.txt)
            curl -X POST -H 'Content-type: application/json' --data "{
              \"blocks\": [
                {
                  \"type\": \"header\",
                  \"text\": {
                    \"type\": \"plain_text\",
                    \"text\": \"âœ… Deployment Succeeded\"
                  }
                },
                {
                  \"type\": \"section\",
                  \"text\": {
                    \"type\": \"mrkdwn\",
                    \"text\": \"Deployment output:\\n$DEPLOY_OUTPUT\"
                  },
                  \"accessory\": {
                    \"type\": \"button\",
                    \"text\": {
                      \"type\": \"plain_text\",
                      \"text\": \"View Log\"
                    },
                    \"url\": \"http://example.com/logs\"
                  }
                }
              ],
              \"channel\": \"ci-cd\",
              \"color\": \"#36a64f\"
            }" https://hooks.slack.com/services/REPLACE/WITH/ACTUAL_WEBHOOK
      - run:
          name: Notify Slack - Deployment Failed
          when: on_fail
          command: |
            DEPLOY_OUTPUT=$(< deploy_output.txt)
            curl -X POST -H 'Content-type: application/json' --data "{
              \"blocks\": [
                {
                  \"type\": \"header\",
                  \"text\": {
                    \"type\": \"plain_text\",
                    \"text\": \"âŒ Deployment Failed\"
                  }
                },
                {
                  \"type\": \"section\",
                  \"text\": {
                    \"type\": \"mrkdwn\",
                    \"text\": \"Failure Details:\\n$DEPLOY_OUTPUT\"
                  }
                }
              ],
              \"channel\": \"ci-cd\",
              \"color\": \"#e01e5a\"
            }" https://hooks.slack.com/services/REPLACE/WITH/ACTUAL_WEBHOOK

workflows:
  version: 2
  example:
    jobs:
      - deploy
