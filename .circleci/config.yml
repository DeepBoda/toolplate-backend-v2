version: 2.1

jobs:
  deploy:
    docker:
      - image: cimg/base:stable
    steps:
      - run:
          name: Notify Slack - Deployment Started
          command: |
            BRANCH=$(git rev-parse --abbrev-ref HEAD)
            COMMIT=$(git rev-parse --short HEAD)
            curl -X POST -H 'Content-type: application/json' --data '{"text":"Website Deployment Started\nBranch: '$BRANCH'\nCommit: '$COMMIT'"}' https://hooks.slack.com/services/REPLACE/WITH/ACTUAL_WEBHOOK
      - checkout
      - add_ssh_keys:
          fingerprints:
            - "SHA256:X3RD1erbC+w6Iqz/fZoHZUrweUqOIny4BgOT1KAruPM"
      - run:
          name: SSH to EC2 and deploy
          command: |
            ssh -o StrictHostKeyChecking=no root@3.111.35.110 "bash /root/toolplate-backend/deploy.sh"
      - run:
          name: Notify Slack - Deployment Succeeded
          when: on_success
          command: |
            AUDIT_RESULTS=$(npm audit --json)
            curl -X POST -H 'Content-type: application/json' --data '{"text":"Website Deployment Succeeded\nAudit Results:\n'$AUDIT_RESULTS'"}' https://hooks.slack.com/services/REPLACE/WITH/ACTUAL_WEBHOOK
      - run:
          name: Notify Slack - Deployment Failed
          when: on_fail
          command: |
            curl -X POST -H 'Content-type: application/json' --data '{"text":"Website Deployment Failed"}' https://hooks.slack.com/services/REPLACE/WITH/ACTUAL_WEBHOOK

workflows:
  version: 2
  example:
    jobs:
      - deploy
